name: build susfs_userspace (ndk)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: source-code

      - name: Download Android NDK r27d
        run: |
          curl -L https://dl.google.com/android/repository/android-ndk-r27d-linux.zip -o ndk.zip
          unzip -q ndk.zip

      - name: Build sstrip (ELFkickers)
        run: |
          curl -L https://www.muppetlabs.com/~breadbox/pub/software/ELFkickers-3.2.tar.gz -o sstrip.tar.gz
          tar xf sstrip.tar.gz
          make -C ELFkickers-3.2 sstrip
          cp ELFkickers-3.2/sstrip/sstrip .
          chmod +x sstrip

      - name: Compile SusFS userspace (ARM64)
        run: |
          set -e

          NDK=android-ndk-r27d/toolchains/llvm/prebuilt/linux-x86_64
          CC=$NDK/bin/aarch64-linux-android21-clang

          echo "Compiler:"
          $CC --version

          VERSION_DIRS=$(find . -maxdepth 1 -type d -name '[0-9]*' | sed 's|./||' | sort -n)

          for i in $VERSION_DIRS; do
            mkdir -p binaries/$i/gki
            [ "$i" != "156" ] && mkdir -p binaries/$i/non-gki
          done

          for i in $VERSION_DIRS; do
            echo "Building GKI for $i"

            $CC \
              -static \
              -Oz \
              -ffunction-sections \
              -fdata-sections \
              -Wl,--gc-sections \
              $i/gki/main.c \
              -o binaries/$i/gki/ksu_susfs_arm64

            if [ "$i" != "156" ]; then
              echo "Building non-GKI for $i"

              $CC \
                -static \
                -Oz \
                -ffunction-sections \
                -fdata-sections \
                -Wl,--gc-sections \
                $i/ngki/main.c \
                -o binaries/$i/non-gki/ksu_susfs_arm64
            fi
          done

      - name: Strip binaries
        run: |
          for f in binaries/*/*/ksu_susfs_arm64; do
            ./sstrip "$f"
          done

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: susfs_binaries_ndk_arm64
          path: binaries/
